<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Burning Candle Simulation</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(to bottom, #1a1a2e 0%, #0f0f1e 100%);
            font-family: Arial, sans-serif;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100vh;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.6;
        }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 25px;
            border-radius: 10px;
            display: flex;
            gap: 15px;
        }
        button {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        button:hover {
            background: #ff8c61;
            transform: scale(1.05);
        }
        button:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div id="info">
        <strong>üïØÔ∏è 3D Burning Candle ID: {{INSTANCE_ID}}</strong><br>
        ‚Ä¢ Click and drag to rotate<br>
        ‚Ä¢ Scroll to zoom<br>
        ‚Ä¢ Watch the candle melt!
    </div>
    <div id="controls">
        <button onclick="toggleFlame()">Toggle Flame</button>
        <button onclick="resetCandle()">Reset Candle</button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, candle, flame, wick, wax;
        let candleHeight = 3;
        let meltAmount = 0;
        let flameActive = true;
        let particles = [];
        let waxDrips = [];
        let mouseX = 0, mouseY = 0;
        let targetRotationX = 0, targetRotationY = 0;
        let currentRotationX = 0, currentRotationY = 0;

        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x1a1a2e, 10, 50);

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 3, 8);
            camera.lookAt(0, 2, 0);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.3);
            scene.add(ambientLight);

            const pointLight = new THREE.PointLight(0xff6b35, 2, 20);
            pointLight.position.set(0, 5, 0);
            pointLight.castShadow = true;
            scene.add(pointLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // Create candle group
            candle = new THREE.Group();
            
            // Candle body (wax)
            const candleGeometry = new THREE.CylinderGeometry(0.5, 0.6, candleHeight, 32);
            const candleMaterial = new THREE.MeshPhongMaterial({
                color: 0xfff8dc,
                shininess: 30,
                transparent: true,
                opacity: 0.95
            });
            wax = new THREE.Mesh(candleGeometry, candleMaterial);
            wax.castShadow = true;
            wax.receiveShadow = true;
            candle.add(wax);

            // Melted wax pool on top
            const poolGeometry = new THREE.CylinderGeometry(0.52, 0.5, 0.1, 32);
            const poolMaterial = new THREE.MeshPhongMaterial({
                color: 0xfff5e6,
                shininess: 60,
                transparent: true,
                opacity: 0.8
            });
            const waxPool = new THREE.Mesh(poolGeometry, poolMaterial);
            waxPool.position.y = candleHeight / 2;
            candle.add(waxPool);

            // Wick
            const wickGeometry = new THREE.CylinderGeometry(0.02, 0.02, 0.5, 8);
            const wickMaterial = new THREE.MeshPhongMaterial({ color: 0x2c2416 });
            wick = new THREE.Mesh(wickGeometry, wickMaterial);
            wick.position.y = candleHeight / 2 + 0.3;
            candle.add(wick);

            // Flame
            createFlame();

            scene.add(candle);

            // Floor
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterial = new THREE.MeshPhongMaterial({
                color: 0x2a2a3e,
                side: THREE.DoubleSide
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = -1.5;
            floor.receiveShadow = true;
            scene.add(floor);

            // Mouse controls
            document.addEventListener('mousedown', onMouseDown);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            document.addEventListener('wheel', onWheel);

            // Touch controls
            document.addEventListener('touchstart', onTouchStart);
            document.addEventListener('touchmove', onTouchMove);

            window.addEventListener('resize', onWindowResize);

            animate();
        }

        function createFlame() {
            flame = new THREE.Group();
            
            // Main flame body
            const flameGeometry = new THREE.SphereGeometry(0.15, 16, 16);
            flameGeometry.scale(1, 1.8, 1);
            
            const flameMaterial = new THREE.MeshBasicMaterial({
                color: 0xff6b35,
                transparent: true,
                opacity: 0.9
            });
            
            const flameCore = new THREE.Mesh(flameGeometry, flameMaterial);
            flame.add(flameCore);
            
            // Inner flame
            const innerFlameGeometry = new THREE.SphereGeometry(0.1, 16, 16);
            innerFlameGeometry.scale(1, 1.5, 1);
            const innerFlameMaterial = new THREE.MeshBasicMaterial({
                color: 0xffeb3b,
                transparent: true,
                opacity: 0.8
            });
            
            const innerFlame = new THREE.Mesh(innerFlameGeometry, innerFlameMaterial);
            innerFlame.position.y = 0.05;
            flame.add(innerFlame);
            
            // Flame glow
            const glowGeometry = new THREE.SphereGeometry(0.25, 16, 16);
            const glowMaterial = new THREE.MeshBasicMaterial({
                color: 0xff6b35,
                transparent: true,
                opacity: 0.3
            });
            
            const glow = new THREE.Mesh(glowGeometry, glowMaterial);
            flame.add(glow);
            
            flame.position.y = candleHeight / 2 + 0.6;
            candle.add(flame);
        }

        function createSmokeParticle() {
            const geometry = new THREE.SphereGeometry(0.05, 8, 8);
            const material = new THREE.MeshBasicMaterial({
                color: 0x888888,
                transparent: true,
                opacity: 0.5
            });
            const particle = new THREE.Mesh(geometry, material);
            particle.position.set(
                (Math.random() - 0.5) * 0.1,
                candleHeight / 2 + 0.8,
                (Math.random() - 0.5) * 0.1
            );
            particle.velocity = {
                x: (Math.random() - 0.5) * 0.02,
                y: Math.random() * 0.03 + 0.02,
                z: (Math.random() - 0.5) * 0.02
            };
            particle.life = 100;
            scene.add(particle);
            particles.push(particle);
        }

        function createWaxDrip() {
            if (Math.random() > 0.98 && meltAmount > 0.1) {
                const dripGeometry = new THREE.SphereGeometry(0.03, 8, 8);
                const dripMaterial = new THREE.MeshPhongMaterial({
                    color: 0xfff8dc,
                    transparent: true,
                    opacity: 0.8
                });
                const drip = new THREE.Mesh(dripGeometry, dripMaterial);
                
                const angle = Math.random() * Math.PI * 2;
                const radius = 0.5;
                
                drip.position.set(
                    Math.cos(angle) * radius,
                    candleHeight / 2 - meltAmount * 0.3,
                    Math.sin(angle) * radius
                );
                
                drip.velocity = { y: -0.02 };
                candle.add(drip);
                waxDrips.push(drip);
            }
        }

        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };

        function onMouseDown(e) {
            isDragging = true;
            previousMousePosition = { x: e.clientX, y: e.clientY };
        }

        function onMouseMove(e) {
            if (isDragging) {
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;
                
                targetRotationY += deltaX * 0.005;
                targetRotationX += deltaY * 0.005;
                targetRotationX = Math.max(-Math.PI / 4, Math.min(Math.PI / 4, targetRotationX));
                
                previousMousePosition = { x: e.clientX, y: e.clientY };
            }
        }

        function onMouseUp() {
            isDragging = false;
        }

        function onWheel(e) {
            camera.position.z += e.deltaY * 0.01;
            camera.position.z = Math.max(4, Math.min(15, camera.position.z));
        }

        function onTouchStart(e) {
            if (e.touches.length === 1) {
                previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        }

        function onTouchMove(e) {
            if (e.touches.length === 1) {
                const deltaX = e.touches[0].clientX - previousMousePosition.x;
                const deltaY = e.touches[0].clientY - previousMousePosition.y;
                
                targetRotationY += deltaX * 0.005;
                targetRotationX += deltaY * 0.005;
                targetRotationX = Math.max(-Math.PI / 4, Math.min(Math.PI / 4, targetRotationX));
                
                previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function toggleFlame() {
            flameActive = !flameActive;
            flame.visible = flameActive;
        }

        function resetCandle() {
            meltAmount = 0;
            candleHeight = 3;
            wax.scale.y = 1;
            wax.position.y = 0;
            wick.position.y = candleHeight / 2 + 0.3;
            flame.position.y = candleHeight / 2 + 0.6;
            
            waxDrips.forEach(drip => candle.remove(drip));
            waxDrips = [];
        }

        function animate() {
            requestAnimationFrame(animate);

            // Smooth rotation
            currentRotationX += (targetRotationX - currentRotationX) * 0.1;
            currentRotationY += (targetRotationY - currentRotationY) * 0.1;
            candle.rotation.x = currentRotationX;
            candle.rotation.y = currentRotationY;

            if (flameActive) {
                // Flame flicker
                const time = Date.now() * 0.005;
                flame.scale.y = 1 + Math.sin(time * 2) * 0.1;
                flame.scale.x = 1 + Math.sin(time * 3) * 0.05;
                flame.scale.z = 1 + Math.cos(time * 2.5) * 0.05;
                flame.rotation.y += 0.02;

                // Candle melting
                meltAmount += 0.0002;
                if (meltAmount < 1.5) {
                    wax.scale.y = 1 - meltAmount * 0.15;
                    wax.position.y = -meltAmount * 0.3;
                    wick.position.y = (candleHeight / 2) * wax.scale.y + 0.3 - meltAmount * 0.3;
                    flame.position.y = wick.position.y + 0.3;
                }

                // Create smoke particles
                if (Math.random() > 0.9) {
                    createSmokeParticle();
                }

                // Create wax drips
                createWaxDrip();
            }

            // Update smoke particles
            particles.forEach((particle, index) => {
                particle.position.x += particle.velocity.x;
                particle.position.y += particle.velocity.y;
                particle.position.z += particle.velocity.z;
                particle.life--;
                particle.material.opacity = particle.life / 100 * 0.5;
                particle.scale.set(1 + (100 - particle.life) * 0.01, 1 + (100 - particle.life) * 0.01, 1 + (100 - particle.life) * 0.01);

                if (particle.life <= 0) {
                    scene.remove(particle);
                    particles.splice(index, 1);
                }
            });

            // Update wax drips
            waxDrips.forEach((drip, index) => {
                drip.position.y += drip.velocity.y;
                drip.scale.y += 0.02;
                
                if (drip.position.y < -2) {
                    candle.remove(drip);
                    waxDrips.splice(index, 1);
                }
            });

            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>